<?php

/**
 * Plugin Name:     ifasanat plugin
 * Plugin URI:      PLUGIN SITE HERE
 * Description:      ifa sanat plugin
 * Author:          YOUR NAME HERE
 * Author URI:      YOUR SITE HERE
 * Text Domain:     ifasanat-plugin
 * Domain Path:     /languages
 * Version:         0.1.0
 *
 * @package         Ifasanat_Plugin
 */

// Your code starts here.

define('__TARGET_URL__','https://webhook.site/9fd72b85-559d-462c-91e5-58925feb86da');
define('__IFA_DEBUG__','TRUE');



//------------------------------------------------------------------------
//--------------------------------log-------------------------------------
//------------------------------------------------------------------------
if (__IFA_DEBUG__=='TRUE') {
	error_log("<pre>imports begin</pre>");
}

require_once(dirname(__File__).'/send_to_api.php');
require_once(dirname(__File__).'/ifa_on_installation.php');
require_once(dirname(__File__).'/ifa_register_rest_route.php');
require_once(dirname(__File__).'/ifa_register_getbyId_rest_route.php');

//------------------------------------------------------------------------
//--------------------------------log-------------------------------------
//------------------------------------------------------------------------
if (__IFA_DEBUG__=='TRUE') {
	error_log("<pre>imports okey</pre>");
}
//------------------------------------------------------------------------
//------------------------------------------------------------------------


//constructor for MyPlugin object
// create initial tables
register_activation_hook(__FILE__, 'ifa_on_installation');


//------------------------------------------------------------------------
//--------------------------------log-------------------------------------
//------------------------------------------------------------------------
if (__IFA_DEBUG__=='TRUE') {
	error_log("<pre>ifa_on_installation registered</pre>");
}
//------------------------------------------------------------------------
//------------------------------------------------------------------------


// register on hook when status changed notify me
add_action('woocommerce_order_status_changed', 'send_order_data_to_api_async', 10, 1);
//add_action('process_order_api_call', 'send_order_data_to_api');



//------------------------------------------------------------------------
//--------------------------------log-------------------------------------
//------------------------------------------------------------------------
if (__IFA_DEBUG__=='TRUE') {
	error_log("<pre>woocommerce_order_status_changed registered</pre>");
}
//------------------------------------------------------------------------
//------------------------------------------------------------------------


add_action('rest_api_init', 'ifa_register_rest_route');


//------------------------------------------------------------------------
//--------------------------------log-------------------------------------
//------------------------------------------------------------------------
if (__IFA_DEBUG__=='TRUE') {
	error_log("<pre>rest_api_init  ifa_register_rest_route registered</pre>");
}
//------------------------------------------------------------------------
//------------------------------------------------------------------------


add_action('rest_api_init', 'ifa_register_getbyId_rest_route');


//------------------------------------------------------------------------
//--------------------------------log-------------------------------------
//------------------------------------------------------------------------
if (__IFA_DEBUG__=='TRUE') {
	error_log("<pre>rest_api_init  ifa_register_getbyId_rest_route registered</pre>");
}
//------------------------------------------------------------------------
//------------------------------------------------------------------------


//------------------------------------------------------------------------
//--------------------------------log-------------------------------------
//------------------------------------------------------------------------
if (__IFA_DEBUG__=='TRUE') {
	error_log("<pre>schedule_retry_event  registering</pre>");
}
//------------------------------------------------------------------------
//------------------------------------------------------------------------



add_action('retry_failed_order_requests', 'retry_failed_order_requests', 10, 1); // Hook for scheduling the API call

function schedule_retry_event() {


	//------------------------------------------------------------------------
	//--------------------------------log-------------------------------------
	//------------------------------------------------------------------------
	if (__IFA_DEBUG__=='TRUE') {
		error_log("<pre>schedule_retry_event  called</pre>");
	}
	//------------------------------------------------------------------------
	//------------------------------------------------------------------------


	if (!wp_next_scheduled('retry_failed_order_requests')) {

		//------------------------------------------------------------------------
		//--------------------------------log-------------------------------------
		//------------------------------------------------------------------------
		if (__IFA_DEBUG__=='TRUE') {
			error_log("<pre>schedule_retry_event ok: if (!wp_next_scheduled('retry_failed_order_requests')) {</pre>");
		}
		//------------------------------------------------------------------------
		//------------------------------------------------------------------------



		wp_schedule_event(time(), 'hourly', 'retry_failed_order_requests'); // Retry every hour


		//------------------------------------------------------------------------
		//--------------------------------log-------------------------------------
		//------------------------------------------------------------------------
		if (__IFA_DEBUG__=='TRUE') {
			error_log("<pre>schedule_retry_event called: wp_schedule_event(time(), 'hourly', 'retry_failed_order_requests') {</pre>");
		}
		//------------------------------------------------------------------------
		//------------------------------------------------------------------------


	}
}
add_action('wp', 'schedule_retry_event');



//------------------------------------------------------------------------
//--------------------------------log-------------------------------------
//------------------------------------------------------------------------
if (__IFA_DEBUG__=='TRUE') {
	error_log("<pre>schedule_retry_event  registered</pre>");
}
//------------------------------------------------------------------------
//------------------------------------------------------------------------
